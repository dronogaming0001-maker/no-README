<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Raj Enterprise - Stock & Sales Management </title>
  <!-- PWA Setup -->
  <meta name="theme-color" content="#3498db">
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js"></script>

  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ“¦</text></svg>">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * { margin:0; padding:0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
:root{
      --primary:#2c3e50; --secondary:#3498db; --accent:#e74c3c;
      --light:#ecf0f1; --dark:#2c3e50; --success:#2ecc71; --warning:#f39c12;
      --danger:#e74c3c; --shadow: 0 4px 6px rgba(0,0,0,0.1); --offline:#7f8c8d; --online:#2ecc71;
    }
    body{ background-color:#f5f7fa; color:#333; min-height:100vh; padding-bottom:60px; }
    .container{ max-width:1200px; margin:20px auto; padding:15px; }
    header{ background:linear-gradient(135deg,var(--primary),var(--secondary)); color:white; padding:15px 20px; border-radius:10px; margin-bottom:20px; box-shadow:var(--shadow); display:flex; gap:10px; align-items:center; justify-content:space-between; position:relative;}
    .app-title{ font-size:22px; font-weight:700; }
    .connection-status{ font-size:12px; display:flex; gap:8px; align-items:center;}
    .status-indicator{ width:10px;height:10px;border-radius:50%; display:inline-block; }
    .online .status-indicator{ background:var(--online); }
    .offline .status-indicator{ background:var(--offline); }
    .current-date{ font-size:13px; opacity:0.95; }
    .nav-tabs{ display:flex; background:#fff; border-radius:10px; overflow:hidden; margin-bottom:20px; box-shadow:var(--shadow); }
    .tab{ flex:1; text-align:center; padding:12px; cursor:pointer; font-weight:500; transition:all .2s; }
    .tab.active{ background:var(--secondary); color:#fff; }
    .content-section{ display:none; background:#fff; border-radius:10px; padding:20px; margin-bottom:20px; box-shadow:var(--shadow); }
    .content-section.active{ display:block; }
    .section-title{ font-size:20px; margin-bottom:15px; color:var(--primary); display:flex; justify-content:space-between; align-items:center; gap:10px; }
    .card{ background:#fff; border-radius:10px; padding:18px; margin-bottom:18px; box-shadow:var(--shadow); }
    .stats-container{ display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:16px; margin-bottom:12px; }
    .stat-card{ background:linear-gradient(135deg,var(--primary),var(--secondary)); color:white; border-radius:10px; padding:14px; text-align:center; box-shadow:var(--shadow); }
    .stat-label{ font-size:13px; opacity:0.95; }
    .stat-value{ font-size:22px; font-weight:700; margin-top:8px; }
    label{ display:block; margin-bottom:6px; font-weight:500; }
    input, select, textarea{ width:100%; padding:10px 12px; border:1px solid #ddd; border-radius:8px; font-size:14px; }
    .form-group{ margin-bottom:12px; }
    .btn{ padding:10px 14px; border:none; border-radius:8px; cursor:pointer; font-weight:600; transition: all 0.2s ease; }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
    .btn-primary{ background:var(--secondary); color:#fff; }
    .btn-danger{ background:var(--danger); color:#fff; }
    .btn-success{ background:var(--success); color:#fff; }
    .btn-warning{ background:var(--warning); color:#fff; }
    table{ width:100%; border-collapse:collapse; margin-top:8px; }
    th,td{ padding:10px 12px; border-bottom:1px solid #eee; text-align:left; font-size:14px; }
    th{ background:#f8f9fa; font-weight:600; }
    .action-buttons button{ margin-right:6px; }
    .search-box{ position:relative; }
    .autocomplete-items{ position:absolute; left:0; right:0; top:100%; background:#fff; border:1px solid #ddd; border-top:none; z-index:99; max-height:200px; overflow:auto; border-radius:0 0 8px 8px; }
    .autocomplete-item{ padding:8px 10px; cursor:pointer; border-bottom:1px solid #eee; }
    .autocomplete-item:hover{ background:#f0f0f0; }
    .notification{ position:fixed; top:20px; right:20px; padding:12px 14px; border-radius:8px; color:#fff; background:var(--success); box-shadow:var(--shadow); z-index:2000; display:none; }
    .modal{ display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:1500; justify-content:center; align-items:center; padding:20px; }
    .modal-content{ background:#fff; padding:16px; border-radius:10px; width:100%; max-width:720px; box-shadow:var(--shadow); }
    .close-modal{ font-size:22px; cursor:pointer; }
    .footer{ text-align:center; padding:12px; margin-top:10px; color:#7f8c8d; font-size:13px; }
    .small{ font-size:13px; color:#555; }
    .muted{ color:#7f8c8d; font-size:13px; }
    .loading { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(255,255,255,.3); border-radius: 50%; border-top-color: #fff; animation: spin 1s ease-in-out infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .tab-loading { display: inline-block; width: 16px; height: 16px; border: 2px solid rgba(255,255,255,.3); border-radius: 50%; border-top-color: #fff; animation: spin 1s ease-in-out infinite; margin-left: 8px; }
    .input-error { border-color: var(--danger) !important; }
    .error-text { color: var(--danger); font-size: 12px; margin-top: 4px; display: none; }
    .data-persistence { display: flex; align-items: center; gap: 8px; font-size: 12px; margin-top: 10px; }
    .last-saved { color: var(--success); }
    @media (max-width:768px){ .nav-tabs{ flex-direction:column; } .stats-container{ grid-template-columns:1fr; } }
    /* Mobile Responsive Styles */
    @media (max-width: 768px) {
      .container {
        padding: 10px;
        margin: 10px auto;
      }
      
      header {
        flex-direction: column;
        text-align: center;
        gap: 15px;
      }
      
      .nav-tabs {
        flex-direction: column;
      }
      
      .stats-container {
        grid-template-columns: 1fr;
      }
      
      .card {
        padding: 15px;
      }
      
      table {
        font-size: 12px;
      }
      
      th, td {
        padding: 8px 6px;
      }
      
      .btn {
        padding: 12px;
        font-size: 14px;
      }
      
      .section-title {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }
    }

    /* Make buttons easier to tap on mobile */
    .btn, .tab {
      min-height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    /* PWA Fullscreen App Styles */
    @media (display-mode: standalone) {
      body {
        padding-top: env(safe-area-inset-top);
        padding-bottom: env(safe-area-inset-bottom);
      }
      
      header {
        border-radius: 0;
        margin-bottom: 0;
      }
      
      .container {
        margin: 0 auto;
        padding: 0;
      }
    }

    /* Mobile app-like styling */
    .standalone-app {
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
    }

    .standalone-app .container {
      max-width: 100%;
      height: 100vh;
      overflow: hidden;
    }

    /* New styles for multi-item bill */
    .bill-item {
      background: #f9f9f9;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 10px;
      border: 1px solid #eee;
    }
    
    .bill-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    
    .bill-item-content {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    
    .remove-item {
      background: var(--danger);
      color: white;
      border: none;
      border-radius: 4px;
      width: 30px;
      height: 30px;
      cursor: pointer;
    }
    
    #current-bill-items {
      margin: 15px 0;
      max-height: 300px;
      overflow-y: auto;
    }
    
    .bill-total {
      font-weight: bold;
      font-size: 18px;
      margin-top: 15px;
      padding-top: 10px;
      border-top: 2px solid #eee;
      text-align: right;
    }
    
    .bill-actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div style="display:flex; gap:12px; align-items:center;">
        <div class="app-title">Raj Enterprise</div>
        <div class="muted small">Stock & Sales Manager Ph.No.: 6386620244 </div>
      </div>

      <div style="display:flex; gap:12px; align-items:center;">
        <div class="current-date" id="header-date">02 Sep 2025 â–¼</div>
        <div class="connection-status offline" id="connection">
          <span class="status-indicator"></span><span id="conn-text">Offline</span>
        </div>
      </div>
    </header>

    <div class="nav-tabs" role="tablist">
      <div class="tab active" data-target="dashboard">
        Dashboard <span class="tab-loading" id="dashboard-loading" style="display: none;"></span>
      </div>
      <div class="tab" data-target="sales">
        Sales <span class="tab-loading" id="sales-loading" style="display: none;"></span>
      </div>
      <div class="tab" data-target="stock">
        Stock <span class="tab-loading" id="stock-loading" style="display: none;"></span>
      </div>
      <div class="tab" data-target="reports">
        Reports <span class="tab-loading" id="reports-loading" style="display: none;"></span>
      </div>
      <div class="tab" data-target="add-product">
        Add Product <span class="tab-loading" id="add-product-loading" style="display: none;"></span>
      </div>
      <div class="tab" data-target="backup">
        Backup <span class="tab-loading" id="backup-loading" style="display: none;"></span>
      </div>
    </div>

    <!-- Dashboard -->
    <div class="content-section active" id="dashboard">
      <div class="section-title">
        <span>Dashboard</span>
        <div style="display:flex; gap:8px; align-items:center;">
          <button class="btn btn-primary" id="sync-button"><i class="fas fa-sync"></i> Sync (export)</button>
          <button class="btn btn-warning" id="manual-sync" style="display: none;">
            <i class="fas fa-sync"></i> Sync Pending Changes
          </button>
          <button class="btn btn-warning" id="import-paste-btn"><i class="fas fa-upload"></i> Import</button>
        </div>
      </div>

      <div class="card">
        <div class="stats-container">
          <div class="stat-card">
            <div class="stat-label">Running Average Sale</div>
            <div class="stat-value" id="running-average">â‚¹0.00</div>
            <div class="stat-desc small">Daily Average</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Monthly Sales</div>
            <div class="stat-value" id="monthly-sales">â‚¹0.00</div>
            <div class="stat-desc small">This month</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Monthly Profit</div>
            <div class="stat-value" id="monthly-profit">â‚¹0.00</div>
            <div class="stat-desc small">This month</div>
          </div>
        </div>

        <div style="margin-top:8px;">
          <h3 style="margin-bottom:8px;">Today's Report</h3>
          <div class="stats-container">
            <div class="stat-card">
              <div class="stat-label">Today's Sales</div>
              <div class="stat-value" id="today-sales-value">â‚¹0.00</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Today's Profit</div>
              <div class="stat-value" id="today-profit-value">â‚¹0.00</div>
            </div>
          </div>
        </div>

        <div style="margin-top:6px;">
          <h3>Low Stock Alert</h3>
          <table>
            <thead><tr><th>Product</th><th>Qty</th><th>Action</th></tr></thead>
            <tbody id="low-stock-alerts"><tr><td colspan="3" style="text-align:center;">Loading...</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Sales -->
    <div class="content-section" id="sales">
      <div class="section-title"><span>Record Sale</span><span class="small muted">Edit or remove sales from the list below</span></div>

      <div class="card">
        <form id="sale-form">
          <!-- Customer Information Section -->
          <div style="border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 15px;">
            <h3 style="margin-bottom: 12px;">Customer Information</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
              <div class="form-group">
                <label for="customer-name">Customer Name</label>
                <input type="text" id="customer-name" placeholder="Enter customer name">
              </div>
              <div class="form-group">
                <label for="customer-phone">Phone Number</label>
                <input type="text" id="customer-phone" placeholder="Enter phone number">
              </div>
              <div class="form-group" style="grid-column: span 2;">
                <label for="customer-address">Address (Optional)</label>
                <textarea id="customer-address" placeholder="Enter customer address" rows="2"></textarea>
              </div>
            </div>
          </div>
          
          <!-- Product Information Section -->
          <h3 style="margin-bottom: 12px;">Product Information</h3>
          <div class="form-group">
            <label for="product-search">Search Product</label>
            <div class="search-box">
              <input type="text" id="product-search" placeholder="Start typing product name...">
              <div class="autocomplete-items" id="autocomplete-list" style="display:none;"></div>
            </div>
          </div>

          <div class="form-group">
            <label for="sale-quantity">Quantity</label>
            <input type="number" id="sale-quantity" min="0.01" step="0.01" value="1">
            <div class="error-text" id="quantity-error">Please enter a valid quantity</div>
          </div>

          <div class="form-group">
            <label for="sale-price">Selling Price (â‚¹) â€” per unit</label>
            <input type="number" id="sale-price" step="0.01" placeholder="Enter selling price">
            <div class="error-text" id="price-error">Please enter a valid price</div>
          </div>

          <input type="hidden" id="sale-product-id">
          <div class="bill-actions">
            <button type="button" id="add-to-bill" class="btn btn-primary">Add to Bill</button>
            <button type="button" id="generate-bill-btn" class="btn btn-warning" disabled>Generate Bill</button>
            <button type="submit" class="btn btn-success">Record Sale</button>
          </div>
        </form>

        <!-- Current Bill Items -->
        <div id="current-bill-items" style="display: none;">
          <h3 style="margin: 15px 0 10px 0;">Current Bill Items</h3>
          <div id="bill-items-container">
            <!-- Bill items will be added here dynamically -->
          </div>
          <div class="bill-total" id="bill-total">
            Total: â‚¹0.00
          </div>
        </div>
      </div>

      <div class="card">
        <h3>Today's Sales</h3>
        <table>
          <thead><tr><th>Product</th><th>Qty</th><th>Price</th><th>Total</th><th>Time</th><th>Actions</th></tr></thead>
          <tbody id="today-sales"><tr><td colspan="6" style="text-align:center;">No sales recorded today</td></tr></tbody>
        </table>
      </div>

      <div class="card">
        <h3>All Sales History</h3>
        <div style="margin-bottom: 15px;">
          <button class="btn btn-primary" id="generate-bill-from-sale">
            <i class="fas fa-receipt"></i> Generate Bill for Selected Sale
          </button>
        </div>
        <table>
          <thead><tr><th>Select</th><th>Date</th><th>Product</th><th>Qty</th><th>Amount</th><th>Profit</th><th>Actions</th></tr></thead>
          <tbody id="all-sales-history"><tr><td colspan="7" style="text-align:center;">No sales yet</td></tr></tbody>
        </table>
      </div>
    </div>

    <!-- Stock -->
    <div class="content-section" id="stock">
      <div class="section-title"><span>Current Stock</span><span class="small muted">Add, edit or remove products</span></div>

      <div class="card">
        <div class="stat-card" style="display:inline-block;">
          <div class="stat-label">Total Stock Value</div>
          <div class="stat-value" id="total-stock-value">â‚¹0.00</div>
        </div>
      </div>

      <div class="card">
        <div class="search-box" style="margin-bottom:10px;">
          <input type="text" id="stock-search" placeholder="Search products...">
        </div>

        <table>
          <thead><tr><th>ID</th><th>Product Name</th><th>Quantity</th><th>Cost Price</th><th>MRP</th><th>Actions</th></tr></thead>
          <tbody id="stock-table"><tr><td colspan="6" style="text-align:center;">Loading...</td></tr></tbody>
        </table>
      </div>
    </div>

    <!-- Reports -->
    <div class="content-section" id="reports">
      <div class="section-title"><span>Sales Reports</span><span class="small muted">Generate totals by date range</span></div>

      <div class="card">
        <div class="date-filter" style="display:flex; gap:12px; flex-wrap:wrap;">
          <div style="flex:1;">
            <label for="report-from">From</label>
            <input type="date" id="report-from">
          </div>
          <div style="flex:1;">
            <label for="report-to">To</label>
            <input type="date" id="report-to">
          </div>
          <div style="align-self:end;">
            <button class="btn btn-primary" id="generate-report">Generate Report</button>
          </div>
        </div>

        <div style="margin-top:12px;">
          <div class="stats-container">
            <div class="stat-card">
              <div class="stat-label">Total Sales</div>
              <div class="stat-value" id="report-total-sales">â‚¹0.00</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Total Profit</div>
              <div class="stat-value" id="report-total-profit">â‚¹0.00</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Items Sold</div>
              <div class="stat-value" id="report-items-sold">0</div>
            </div>
          </div>

          <h3>Sales History (Filtered)</h3>
          <table>
            <thead><tr><th>Date</th><th>Product</th><th>Qty</th><th>Amount</th><th>Profit</th></tr></thead>
            <tbody id="sales-history"><tr><td colspan="5" style="text-align:center;">No sales data available</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Add Product -->
    <div class="content-section" id="add-product">
      <div class="section-title"><span>Add New Product</span></div>

      <div class="card">
        <form id="product-form">
          <div class="form-group">
            <label for="product-name">Product Name</label>
            <input type="text" id="product-name" required placeholder="Enter product name">
            <div class="error-text" id="name-error">Please enter a product name</div>
          </div>
          <div class="form-group">
            <label for="product-quantity">Initial Quantity</label>
            <input type="number" id="product-quantity" min="0" step="0.01" value="0">
            <div class="error-text" id="init-qty-error">Please enter a valid quantity</div>
          </div>
          <div class="form-group">
            <label for="product-cost">Cost Price (â‚¹)</label>
            <input type="number" id="product-cost" step="0.01" value="0">
            <div class="error-text" id="cost-error">Please enter a valid cost price</div>
          </div>
          <div class="form-group">
            <label for="product-mrp">MRP (â‚¹)</label>
            <input type="number" id="product-mrp" step="0.01" value="0">
            <div class="error-text" id="mrp-error">Please enter a valid MRP</div>
          </div>
          <div class="form-group">
            <label for="product-tax">Tax (%)</label>
            <input type="number" id="product-tax" min="0" max="100" step="0.1" value="0">
            <div class="error-text" id="tax-error">Please enter a valid tax percentage</div>
          </div>

          <button type="submit" class="btn btn-success">Add Product</button>
        </form>
      </div>
    </div>

    <!-- Backup / Import -->
    <div class="content-section" id="backup">
      <div class="section-title"><span>Backup & Restore</span></div>

      <div class="card">
        <p class="small">You can export full DB (products + sales + settings) as a JSON file, re-import it to restore, or save to local disk (File System API when supported).</p>

        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button id="export-json" class="btn btn-primary"><i class="fas fa-file-export"></i> Download Backup (JSON)</button>
          <button id="save-disk" class="btn btn-primary"><i class="fas fa-save"></i> Save Backup to Disk</button>
          <label class="btn btn-warning" style="display:inline-block; cursor:pointer;">
            <i class="fas fa-file-import"></i> Import Backup
            <input type="file" id="file-input" accept="application/json" style="display:none;">
          </label>

          <button id="clear-db" class="btn btn-danger"><i class="fas fa-trash"></i> Clear Local DB</button>
        </div>

        <div class="data-persistence">
          <i class="fas fa-database"></i>
          <span>Data is stored locally in your browser</span>
          <span class="last-saved" id="last-saved">Last saved: Just now</span>
        </div>
        <div class="offline-notice small" style="color: var(--warning); display: none;" id="offline-notice">
          <i class="fas fa-wifi"></i> Offline mode - changes will sync when connected
        </div>

        <hr style="margin:12px 0;">
        <div>
          <h4>Cloud sync / integration notes</h4>
          <p class="small muted">For direct Google Drive / Firebase sync you'll need to create OAuth credentials (client ID) and call the Drive/Firebase REST SDK. I can produce exact code to integrate once you provide client settings (or I can guide step-by-step).</p>
        </div>
      </div>
    </div>

    <!-- Edit product modal -->
    <div class="modal" id="edit-product-modal" aria-hidden="true">
      <div class="modal-content">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <h3>Edit Product</h3>
          <span class="close-modal" id="close-edit-product">&times;</span>
        </div>
        <form id="edit-product-form">
          <input type="hidden" id="edit-product-id">
          <div class="form-group">
            <label for="edit-product-name">Product Name</label>
            <input type="text" id="edit-product-name" required>
            <div class="error-text" id="edit-name-error">Please enter a product name</div>
          </div>
          <div class="form-group">
            <label for="edit-product-quantity">Quantity</label>
            <input type="number" id="edit-product-quantity" min="0" step="0.01" required>
            <div class="error-text" id="edit-qty-error">Please enter a valid quantity</div>
          </div>
          <div class="form-group">
            <label for="edit-product-cost">Cost Price (â‚¹)</label>
            <input type="number" id="edit-product-cost" step="0.01" required>
            <div class="error-text" id="edit-cost-error">Please enter a valid cost price</div>
          </div>
          <div class="form-group">
            <label for="edit-product-mrp">MRP (â‚¹)</label>
            <input type="number" id="edit-product-mrp" step="0.01" required>
            <div class="error-text" id="edit-mrp-error">Please enter a valid MRP</div>
          </div>
          <div class="form-group">
            <label for="edit-product-tax">Tax (%)</label>
            <input type="number" id="edit-product-tax" min="0" max="100" step="0.1">
            <div class="error-text" id="edit-tax-error">Please enter a valid tax percentage</div>
          </div>
          <button type="submit" class="btn btn-success">Update Product</button>
        </form>
      </div>
    </div>

    <!-- Edit sale modal -->
    <div class="modal" id="edit-sale-modal" aria-hidden="true">
      <div class="modal-content">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <h3>Edit Sale</h3>
          <span class="close-modal" id="close-edit-sale">&times;</span>
        </div>
        <form id="edit-sale-form">
          <input type="hidden" id="edit-sale-id">
          <div class="form-group">
            <label for="edit-sale-product">Product (readonly)</label>
            <input type="text" id="edit-sale-product" readonly>
          </div>
          <div class="form-group">
            <label for="edit-sale-quantity">Quantity</label>
            <input type="number" id="edit-sale-quantity" min="0.01" step="0.01" required>
            <div class="error-text" id="edit-sale-qty-error">Please enter a valid quantity</div>
          </div>
          <div class="form-group">
            <label for="edit-sale-price">Selling Price (â‚¹) â€” per unit</label>
            <input type="number" id="edit-sale-price" step="0.01" required>
            <div class="error-text" id="edit-sale-price-error">Please enter a valid price</div>
          </div>
          <button type="submit" class="btn btn-success">Update Sale</button>
        </form>
      </div>
    </div>

    <!-- Bill Modal -->
    <div class="modal" id="bill-modal" aria-hidden="true">
      <div class="modal-content" style="max-width:800px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
          <h3>Bill Receipt</h3>
          <span class="close-modal" id="close-bill">&times;</span>
        </div>
        <div id="bill-content" style="background:white; padding:20px; border-radius:8px;">
          <!-- Bill content will be inserted here by JavaScript -->
        </div>
        <div style="margin-top:20px; text-align:center;">
          <button class="btn btn-primary" id="print-bill-btn">
            <i class="fas fa-print"></i> Print Bill
          </button>
        </div>
      </div>
    </div>

    <!-- Select Sales for Bill Modal -->
    <div class="modal" id="select-sales-modal" aria-hidden="true">
      <div class="modal-content" style="max-width:800px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
          <h3>Select Sales for Bill</h3>
          <span class="close-modal" id="close-select-sales">&times;</span>
        </div>
        <div style="max-height:400px; overflow-y:auto;">
          <table>
            <thead>
              <tr>
                <th>Select</th>
                <th>Date</th>
                <th>Product</th>
                <th>Qty</th>
                <th>Amount</th>
              </tr>
            </thead>
            <tbody id="select-sales-table">
              <!-- Sales will be populated here -->
            </tbody>
          </table>
        </div>
        <div style="margin-top:20px; text-align:center;">
          <button class="btn btn-primary" id="generate-bill-from-selected">
            Generate Bill for Selected Items
          </button>
        </div>
      </div>
    </div>

    <div class="notification" id="notification">Notification</div>

    <div class="footer">Raj Enterprise Stock & Sales Management no.->6386620244 System Â© 2025</div>
  </div>div class="container">

  <script>
    // ========== IndexedDB Setup ==========
    const DB_NAME = 'RajEnterpriseDB';
    const DB_VERSION = 1;
    let db = null;

    function openDB(){
      return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);
        request.onerror = (e) => reject(e.target.error);
        request.onupgradeneeded = (e) => {
          db = e.target.result;
          if (!db.objectStoreNames.contains('products')) {
            const products = db.createObjectStore('products', { keyPath:'id', autoIncrement:true });
            products.createIndex('name', 'name', { unique:false });
          }
          if (!db.objectStoreNames.contains('sales')) {
            const sales = db.createObjectStore('sales', { keyPath:'id', autoIncrement:true });
            sales.createIndex('date', 'date', { unique:false });
            sales.createIndex('productId', 'productId', { unique:false });
          }
          if (!db.objectStoreNames.contains('settings')) {
            db.createObjectStore('settings', { keyPath:'id' });
          }
        };
        request.onsuccess = (e) => { db = e.target.result; resolve(db); };
      });
    }

    // helpers
    function tx(storeNames, mode='readonly'){
      return db.transaction(storeNames, mode);
    }
    function promisifyRequest(request){
      return new Promise((resolve,reject)=>{
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
      });
    }

    // ========== Utility ==========

    function showNotification(message, type='success'){
      const el = document.getElementById('notification');
      el.textContent = message;
      el.style.backgroundColor = type === 'error' ? 'var(--danger)' : 'var(--success)';
      el.style.display = 'block';
      setTimeout(()=> el.style.display='none', 3000);
      
      // Update last saved indicator
      if (type === 'success') {
        document.getElementById('last-saved').textContent = 'Last saved: ' + new Date().toLocaleTimeString();
      }
    }

    function formatCurrency(n){
      const v = Number(n) || 0;
      return 'â‚¹' + v.toFixed(2);
    }
    
    function validateNumberInput(input, errorElement, min = 0) {
      const value = Number(input.value);
      if (isNaN(value) || value < min) {
        input.classList.add('input-error');
        errorElement.style.display = 'block';
        return false;
      } else {
        input.classList.remove('input-error');
        errorElement.style.display = 'none';
        return true;
      }
    }
    
    function validateRequiredInput(input, errorElement) {
      if (!input.value.trim()) {
        input.classList.add('input-error');
        errorElement.style.display = 'block';
        return false;
      } else {
        input.classList.remove('input-error');
        errorElement.style.display = 'none';
        return true;
      }
    }

    // ========== Load / Display ==========
    async function loadInitialData(){
      await loadProducts();
      await loadSales();
      await loadLowStockAlerts();
      computeDashboardMetrics();
    }

    // PRODUCTS
    async function loadProducts(){
      showTabLoading('stock');
      try {
        const store = tx(['products']).objectStore('products');
        const req = store.getAll();
        const products = await promisifyRequest(req);
        displayProducts(products);
        window._productsCache = products; // quick access
        updateStockValue(products);
      } finally {
        hideTabLoading('stock');
      }
    }

    function displayProducts(products){
      const table = document.getElementById('stock-table');
      if (!table) {
        console.error("Element with ID 'stock-table' not found");
        return;
      }
      
      table.innerHTML = '';
      if (!products || products.length === 0){
        table.innerHTML = '<tr><td colspan="6" style="text-align:center;">No products found</td></tr>';
        return;
      }
      
      // Display sequential numbers instead of actual IDs
      products.forEach((p, index) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${index + 1}</td> <!-- Sequential number instead of p.id -->
          <td>${p.name.toUpperCase()}</td> <!-- Product name in uppercase -->
          <td>${p.quantity}</td>
          <td>${formatCurrency(p.costPrice)}</td>
          <td>${formatCurrency(p.mrp)}</td>
          <td class="action-buttons">
            <button class="btn btn-primary edit-product" data-id="${p.id}">Edit</button>
            <button class="btn btn-danger delete-product" data-id="${p.id}">Remove</button>
          </td>
        `;
        table.appendChild(tr);
      });

      document.querySelectorAll('.edit-product').forEach(btn=>{
        btn.addEventListener('click', (e)=>{
          const id = Number(e.currentTarget.dataset.id);
          openEditProductModal(id);
        });
      });
      document.querySelectorAll('.delete-product').forEach(btn=>{
        btn.addEventListener('click', (e)=>{
          const id = Number(e.currentTarget.dataset.id);
          deleteProduct(id);
        });
      });
    }

    async function addProduct(product){
      try{
        const store = tx(['products'],'readwrite').objectStore('products');
        const req = store.add(product);
        await promisifyRequest(req);
        showNotification('Product added successfully');
        await loadProducts();
        await loadLowStockAlerts();
      }catch(err){
        console.error(err);
        showNotification('Error adding product','error');
      }
    }

    async function openEditProductModal(productId){
      const store = tx(['products']).objectStore('products');
      const product = await promisifyRequest(store.get(productId));
      if (!product) { showNotification('Product not found','error'); return; }
      document.getElementById('edit-product-id').value = product.id;
      document.getElementById('edit-product-name').value = product.name;
      document.getElementById('edit-product-quantity').value = product.quantity;
      document.getElementById('edit-product-cost').value = product.costPrice;
      document.getElementById('edit-product-mrp').value = product.mrp;
      document.getElementById('edit-product-tax').value = product.tax || 0;
      document.getElementById('edit-product-modal').style.display = 'flex';
    }

    async function updateProduct(product){
      try{
        const store = tx(['products'],'readwrite').objectStore('products');
        const req = store.put(product);
        await promisifyRequest(req);
        showNotification('Product updated');
        document.getElementById('edit-product-modal').style.display = 'none';
        await loadProducts();
        await loadLowStockAlerts();
      }catch(err){ console.error(err); showNotification('Error updating product','error'); }
    }

    async function deleteProduct(productId){
      if (!confirm('Are you sure you want to delete this product? This will not delete related sales.')) return;
      try{
        const store = tx(['products'],'readwrite').objectStore('products');
        await promisifyRequest(store.delete(productId));
        showNotification('Product deleted');
        await loadProducts();
        await loadLowStockAlerts();
      }catch(err){ console.error(err); showNotification('Error deleting product','error'); }
    }

    // SALES
    async function loadSales() {
      showTabLoading('sales');
      try {
        const store = tx(['sales']).objectStore('sales');
        const req = store.getAll();
        const sales = await promisifyRequest(req);
        window._salesCache = sales;
        displayTodaySales(sales);
        displayAllSales(sales);
      } finally {
        hideTabLoading('sales');
      }
    }

    function displayTodaySales(sales) {
      const tbody = document.getElementById('today-sales');
      if (!tbody) {
        console.error("Element with ID 'today-sales' not found");
        return;
      }
      
      const today = new Date().toISOString().split('T')[0];
      const todaySales = sales.filter(sale => sale.date.startsWith(today));

      // Reverse the array to show latest sales first
      todaySales.reverse();
      
      tbody.innerHTML = '';
      if (todaySales.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">No sales recorded today</td></tr>';
        return;
      }
      
      todaySales.forEach(sale => {
        const product = window._productsCache.find(p => p.id === sale.productId);
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${product ? product.name.toUpperCase() : 'Unknown Product'}</td> <!-- Product name in uppercase -->
          <td>${sale.quantity}</td>
          <td>${formatCurrency(sale.pricePerUnit)}</td>
          <td>${formatCurrency(sale.quantity * sale.pricePerUnit)}</td>
          <td>${new Date(sale.date).toLocaleTimeString()}</td>
          <td class="action-buttons">
            <button class="btn btn-primary edit-sale" data-id="${sale.id}">Edit</button>
            <button class="btn btn-danger delete-sale" data-id="${sale.id}">Remove</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
      
      // Add event listeners for edit/delete buttons
      document.querySelectorAll('.edit-sale').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const id = Number(e.currentTarget.dataset.id);
          openEditSaleModal(id);
        });
      });
      
      document.querySelectorAll('.delete-sale').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const id = Number(e.currentTarget.dataset.id);
          deleteSale(id);
        });
      });
    }

    function displayAllSales(sales) {
      const tbody = document.getElementById('all-sales-history');
      if (!tbody) {
        console.error("Element with ID 'all-sales-history' not found");
        return;
      }
      
      tbody.innerHTML = '';
      if (sales.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">No sales yet</td></tr>';
        return;
      }
      
      // Sort sales by date (newest first)
      sales.sort((a, b) => new Date(b.date) - new Date(a.date));
      
      sales.forEach(sale => {
        const product = window._productsCache.find(p => p.id === sale.productId);
        const profit = product ? (sale.pricePerUnit - product.costPrice) * sale.quantity : 0;
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><input type="checkbox" class="sale-checkbox" data-id="${sale.id}"></td>
          <td>${new Date(sale.date).toLocaleDateString()}</td>
          <td>${product ? product.name.toUpperCase() : 'Unknown Product'}</td> <!-- Product name in uppercase -->
          <td>${sale.quantity}</td>
          <td>${formatCurrency(sale.quantity * sale.pricePerUnit)}</td>
          <td>${formatCurrency(profit)}</td>
          <td class="action-buttons">
            <button class="btn btn-primary edit-sale" data-id="${sale.id}">Edit</button>
            <button class="btn btn-danger delete-sale" data-id="${sale.id}">Remove</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
      
      // Add event listeners for edit/delete buttons
      document.querySelectorAll('.edit-sale').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const id = Number(e.currentTarget.dataset.id);
          openEditSaleModal(id);
        });
      });
      
      document.querySelectorAll('.delete-sale').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const id = Number(e.currentTarget.dataset.id);
          deleteSale(id);
        });
      });
    }

    // Current bill items array
    let currentBillItems = [];

    // Function to add item to current bill
    function addItemToBill() {
      const productId = document.getElementById('sale-product-id').value;
      const quantity = document.getElementById('sale-quantity').value;
      const price = document.getElementById('sale-price').value;
      
      if (!productId) {
        showNotification('Please select a product', 'error');
        return;
      }
      
      if (!validateNumberInput(document.getElementById('sale-quantity'), document.getElementById('quantity-error'), 0.01) ||
          !validateNumberInput(document.getElementById('sale-price'), document.getElementById('price-error'), 0.01)) {
        return;
      }
      
      const product = window._productsCache.find(p => p.id === Number(productId));
      if (!product) {
        showNotification('Product not found', 'error');
        return;
      }
      
      // Check if product already exists in bill
      const existingItemIndex = currentBillItems.findIndex(item => item.productId === Number(productId));
      
      if (existingItemIndex !== -1) {
        // Update existing item
        currentBillItems[existingItemIndex].quantity += Number(quantity);
        currentBillItems[existingItemIndex].total = currentBillItems[existingItemIndex].quantity * currentBillItems[existingItemIndex].pricePerUnit;
      } else {
        // Add new item
        currentBillItems.push({
          productId: Number(productId),
          productName: product.name.toUpperCase(), // Product name in uppercase
          quantity: Number(quantity),
          pricePerUnit: Number(price),
          total: Number(quantity) * Number(price)
        });
      }
      
      // Update bill display
      updateBillDisplay();
      
      // Clear form
      document.getElementById('product-search').value = '';
      document.getElementById('sale-product-id').value = '';
      document.getElementById('sale-quantity').value = '1';
      document.getElementById('sale-price').value = '';
      
      showNotification('Item added to bill');
    }

    // Function to update bill display
    function updateBillDisplay() {
      const container = document.getElementById('bill-items-container');
      const totalElement = document.getElementById('bill-total');
      const billSection = document.getElementById('current-bill-items');
      const generateBillBtn = document.getElementById('generate-bill-btn');
      
      container.innerHTML = '';
      
      if (currentBillItems.length === 0) {
        billSection.style.display = 'none';
        generateBillBtn.disabled = true;
        return;
      }
      
      billSection.style.display = 'block';
      generateBillBtn.disabled = false;
      
      let total = 0;
      
      currentBillItems.forEach((item, index) => {
        total += item.total;
        
        const itemElement = document.createElement('div');
        itemElement.className = 'bill-item';
        itemElement.innerHTML = `
          <div class="bill-item-header">
            <strong>${item.productName}</strong>
            <button class="remove-item" data-index="${index}">&times;</button>
          </div>
          <div class="bill-item-content">
            <div>Quantity: ${item.quantity}</div>
            <div>Price: ${formatCurrency(item.pricePerUnit)}</div>
            <div>Total: ${formatCurrency(item.total)}</div>
          </div>
        `;
        
        container.appendChild(itemElement);
      });
      
      totalElement.textContent = `Total: ${formatCurrency(total)}`;
      
      // Add event listeners to remove buttons
      document.querySelectorAll('.remove-item').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const index = parseInt(e.target.dataset.index);
          currentBillItems.splice(index, 1);
          updateBillDisplay();
        });
      });
    }

    // Function to record sale from bill items
    async function recordBillSale() {
      if (currentBillItems.length === 0) {
        showNotification('No items in bill', 'error');
        return;
      }
      
      // Get customer info
      const customerInfo = {
        name: document.getElementById('customer-name').value,
        phone: document.getElementById('customer-phone').value,
        address: document.getElementById('customer-address').value
      };
      
      try {
        const store = tx(['sales', 'products'], 'readwrite');
        const salesStore = store.objectStore('sales');
        const productsStore = store.objectStore('products');
        
        // Process each item in the bill
        for (const item of currentBillItems) {
          // Get the product to update its quantity
          const product = await promisifyRequest(productsStore.get(item.productId));
          if (!product) {
            showNotification(`Product not found: ${item.productName}`, 'error');
            continue;
          }
          
          // Check if there's enough stock
          if (product.quantity < item.quantity) {
            showNotification(`Not enough stock for ${product.name}. Only ${product.quantity} available.`, 'error');
            continue;
          }
          
          // Update product quantity
          product.quantity -= item.quantity;
          await promisifyRequest(productsStore.put(product));
          
          // Add the sale
          const saleData = {
            productId: item.productId,
            quantity: item.quantity,
            pricePerUnit: item.pricePerUnit,
            date: new Date().toISOString(),
            customerName: customerInfo.name,
            customerPhone: customerInfo.phone,
            customerAddress: customerInfo.address
          };
          
          await promisifyRequest(salesStore.add(saleData));
        }
        
        showNotification('Sale recorded successfully');
        
        // Generate and show bill
        generateBillFromItems(currentBillItems, customerInfo);
        
        // Reset form and bill
        document.getElementById('sale-form').reset();
        currentBillItems = [];
        updateBillDisplay();
        
        await loadSales();
        await loadProducts();
        await loadLowStockAlerts();
        computeDashboardMetrics();
      } catch (err) {
        console.error(err);
        showNotification('Error recording sale', 'error');
      }
    }

    // Function to generate bill from items
    function generateBillFromItems(items, customerInfo) {
      const billContent = generateBillContent(items, customerInfo);
      document.getElementById('bill-content').innerHTML = billContent;
      document.getElementById('bill-modal').style.display = 'flex';
    }

    // Function to generate bill for existing sale
    async function generateBillForExistingSale(saleId) {
      try {
        const store = tx(['sales']).objectStore('sales');
        const sale = await promisifyRequest(store.get(saleId));
        
        if (!sale) {
          showNotification('Sale not found', 'error');
          return;
        }
        
        const product = window._productsCache.find(p => p.id === sale.productId);
        if (!product) {
          showNotification('Product not found', 'error');
          return;
        }
        
        const customerInfo = {
          name: sale.customerName || 'Walk-in Customer',
          phone: sale.customerPhone || '',
          address: sale.customerAddress || ''
        };
        
        const billItem = [{
          productId: sale.productId,
          productName: product.name.toUpperCase(), // Product name in uppercase
          quantity: sale.quantity,
          pricePerUnit: sale.pricePerUnit,
          total: sale.quantity * sale.pricePerUnit
        }];
        
        generateBillFromItems(billItem, customerInfo);
      } catch (err) {
        console.error(err);
        showNotification('Error generating bill', 'error');
      }
    }

    // Function to generate bill for multiple selected sales
    async function generateBillForSelectedSales(saleIds) {
      try {
        const store = tx(['sales']).objectStore('sales');
        const sales = [];
        
        for (const id of saleIds) {
          const sale = await promisifyRequest(store.get(id));
          if (sale) {
            sales.push(sale);
          }
        }
        
        if (sales.length === 0) {
          showNotification('No sales selected', 'error');
          return;
        }
        
        // Group sales by customer (assuming same customer for all selected sales)
        const customerInfo = {
          name: sales[0].customerName || 'Walk-in Customer',
          phone: sales[0].customerPhone || '',
          address: sales[0].customerAddress || ''
        };
        
        const billItems = [];
        
        for (const sale of sales) {
          const product = window._productsCache.find(p => p.id === sale.productId);
          if (product) {
            billItems.push({
              productId: sale.productId,
              productName: product.name.toUpperCase(), // Product name in uppercase
              quantity: sale.quantity,
              pricePerUnit: sale.pricePerUnit,
              total: sale.quantity * sale.pricePerUnit
            });
          }
        }
        
        generateBillFromItems(billItems, customerInfo);
      } catch (err) {
        console.error(err);
        showNotification('Error generating bill', 'error');
      }
    }

    // Function to open modal for selecting multiple sales for bill
    function openSelectSalesModal() {
      const tbody = document.getElementById('select-sales-table');
      tbody.innerHTML = '';
      
      if (!window._salesCache || window._salesCache.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No sales available</td></tr>';
      } else {
        window._salesCache.forEach(sale => {
          const product = window._productsCache.find(p => p.id === sale.productId);
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td><input type="checkbox" class="select-sale-checkbox" data-id="${sale.id}"></td>
            <td>${new Date(sale.date).toLocaleDateString()}</td>
            <td>${product ? product.name.toUpperCase() : 'Unknown Product'}</td> <!-- Product name in uppercase -->
            <td>${sale.quantity}</td>
            <td>${formatCurrency(sale.quantity * sale.pricePerUnit)}</td>
          `;
          tbody.appendChild(tr);
        });
      }
      
      document.getElementById('select-sales-modal').style.display = 'flex';
    }

    async function recordSale(saleData, customerInfo) {
      try {
        const store = tx(['sales', 'products'], 'readwrite');
        const salesStore = store.objectStore('sales');
        const productsStore = store.objectStore('products');
        
        // Get the product to update its quantity
        const product = await promisifyRequest(productsStore.get(saleData.productId));
        if (!product) {
          showNotification('Product not found', 'error');
          return;
        }
        
        // Check if there's enough stock
        if (product.quantity < saleData.quantity) {
          showNotification(`Not enough stock. Only ${product.quantity} available.`, 'error');
          return;
        }
        
        // Update product quantity
        product.quantity -= saleData.quantity;
        await promisifyRequest(productsStore.put(product));
        
        // Add customer info to sale data
        const saleWithCustomer = {
          ...saleData,
          customerName: customerInfo.name,
          customerPhone: customerInfo.phone,
          customerAddress: customerInfo.address
        };
        
        // Add the sale
        await promisifyRequest(salesStore.add(saleWithCustomer));
        
        showNotification('Sale recorded successfully');
        document.getElementById('sale-form').reset();
        document.getElementById('sale-product-id').value = '';
        
        await loadSales();
        await loadProducts();
        await loadLowStockAlerts();
        computeDashboardMetrics();
      } catch (err) {
        console.error(err);
        showNotification('Error recording sale', 'error');
      }
    }

    async function openEditSaleModal(saleId) {
      const store = tx(['sales']).objectStore('sales');
      const sale = await promisifyRequest(store.get(saleId));
      
      if (!sale) {
        showNotification('Sale not found', 'error');
        return;
      }
      
      const product = window._productsCache.find(p => p.id === sale.productId);
      
      document.getElementById('edit-sale-id').value = sale.id;
      document.getElementById('edit-sale-product').value = product ? product.name.toUpperCase() : 'Unknown Product'; // Product name in uppercase
      document.getElementById('edit-sale-quantity').value = sale.quantity;
      document.getElementById('edit-sale-price').value = sale.pricePerUnit;
      document.getElementById('edit-sale-modal').style.display = 'flex';
    }

    async function updateSale(updatedSale) {
      try {
        const store = tx(['sales', 'products'], 'readwrite');
        const salesStore = store.objectStore('sales');
        const productsStore = store.objectStore('products');
        
        // Get the original sale and product
        const originalSale = await promisifyRequest(salesStore.get(updatedSale.id));
        const product = await promisifyRequest(productsStore.get(originalSale.productId));
        
        // Calculate quantity difference
        const quantityDiff = originalSale.quantity - updatedSale.quantity;
        
        // Update product quantity
        product.quantity += quantityDiff;
        await promisifyRequest(productsStore.put(product));
        
        // Update the sale
        await promisifyRequest(salesStore.put(updatedSale));
        
        showNotification('Sale updated successfully');
        document.getElementById('edit-sale-modal').style.display = 'none';
        
        await loadSales();
        await loadProducts();
        await loadLowStockAlerts();
        computeDashboardMetrics();
      } catch (err) {
        console.error(err);
        showNotification('Error updating sale', 'error');
      }
    }

    async function deleteSale(saleId) {
      if (!confirm('Are you sure you want to delete this sale?')) return;
      
      try {
        const store = tx(['sales', 'products'], 'readwrite');
        const salesStore = store.objectStore('sales');
        const productsStore = store.objectStore('products');
        
        // Get the sale to restore product quantity
        const sale = await promisifyRequest(salesStore.get(saleId));
        if (!sale) {
          showNotification('Sale not found', 'error');
          return;
        }
        
        // Get the product and restore quantity
        const product = await promisifyRequest(productsStore.get(sale.productId));
        if (product) {
          product.quantity += sale.quantity;
          await promisifyRequest(productsStore.put(product));
        }
        
        // Delete the sale
        await promisifyRequest(salesStore.delete(saleId));
        
        showNotification('Sale deleted successfully');
        
        await loadSales();
        await loadProducts();
        await loadLowStockAlerts();
        computeDashboardMetrics();
      } catch (err) {
        console.error(err);
        showNotification('Error deleting sale', 'error');
      }
    }

    // ========== AUTCOMPLETE FUNCTIONALITY ==========
    function setupProductSearchAutocomplete() {
      const searchInput = document.getElementById('product-search');
      const autocompleteList = document.getElementById('autocomplete-list');
      const productIdInput = document.getElementById('sale-product-id');
      const salePriceInput = document.getElementById('sale-price');
      
      if (!searchInput || !autocompleteList) {
        console.error("Autocomplete elements not found");
        return;
      }
      
      searchInput.addEventListener('input', function() {
        const value = this.value.trim().toLowerCase();
        autocompleteList.innerHTML = '';
        autocompleteList.style.display = 'none';
        
        if (value.length < 2) return;
        
        const matches = (window._productsCache || []).filter(product => 
          product.name.toLowerCase().includes(value) && product.quantity > 0
        );
        
        if (matches.length === 0) return;
          {autocompleteList.style.display = 'block';
          matches.forEach(product => {
            const item = document.createElement('div');
            item.className = 'autocomplete-item';
            item.textContent = `${product.name.toUpperCase()} (Stock: ${product.quantity})`; // Product name in uppercase
            item.dataset.id = product.id;
            item.dataset.mrp = product.mrp;
            
            item.addEventListener('click', function() {
              searchInput.value = product.name.toUpperCase(); // Product name in uppercase
              productIdInput.value = product.id;
              salePriceInput.value = product.mrp;
              autocompleteList.style.display = 'none';
            });
            
            autocompleteList.appendChild(item);
          });
        }
      });
      
      // Hide autocomplete when clicking outside
      document.addEventListener('click', function(e) {
        if (!e.target.closest('.search-box')) {
          autocompleteList.style.display = 'none';
        }
      });
      
      // Keyboard navigation
      searchInput.addEventListener('keydown', function(e) {
        const items = autocompleteList.querySelectorAll('.autocomplete-item');
        if (items.length === 0) return;
        
        let activeItem = autocompleteList.querySelector('.autocomplete-active');
        
        if (e.key === 'ArrowDown') {
          e.preventDefault();
          if (!activeItem) {
            items[0].classList.add('autocomplete-active');
          } else {
            activeItem.classList.remove('autocomplete-active');
            if (activeItem.nextSibling) {
              activeItem.nextSibling.classList.add('autocomplete-active');
            } else {
              items[0].classList.add('autocomplete-active');
            }
          }
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          if (!activeItem) {
            items[items.length - 1].classList.add('autocomplete-active');
          } else {
            activeItem.classList.remove('autocomplete-active');
            if (activeItem.previousSibling) {
              activeItem.previousSibling.classList.add('autocomplete-active');
            } else {
              items[items.length - 1].classList.add('autocomplete-active');
            }
          }
        } else if (e.key === 'Enter' && activeItem) {
          e.preventDefault();
          activeItem.click();
        }
      });
    }

    // Add this CSS for the active autocomplete item
    document.head.insertAdjacentHTML('beforeend', `
      <style>
        .autocomplete-active {
          background-color: var(--secondary) !important;
          color: white;
        }
      </style>
    `);

    // ========== DASHBOARD METRICS ==========
    function computeDashboardMetrics() {
      // Today's metrics
      if (!window._salesCache || !window._productsCache) {
        console.log("Data not loaded yet");
        return; 
      }
      const today = new Date().toISOString().split('T')[0];
      const todaySales = window._salesCache ? window._salesCache.filter(sale => sale.date.startsWith(today)) : [];
      
      let todaySalesValue = 0;
      let todayProfitValue = 0;
      
      todaySales.forEach(sale => {
        const product = window._productsCache.find(p => p.id === sale.productId);
        if (product) {
          todaySalesValue += sale.quantity * sale.pricePerUnit;
          todayProfitValue += (sale.pricePerUnit - product.costPrice) * sale.quantity;
        }
      });
      
      document.getElementById('today-sales-value').textContent = formatCurrency(todaySalesValue);
      document.getElementById('today-profit-value').textContent = formatCurrency(todayProfitValue);
      
      // Monthly metrics (current month)
      const currentMonth = new Date().getMonth();
      const currentYear = new Date().getFullYear();
      
      const monthlySales = window._salesCache ? window._salesCache.filter(sale => {
        const saleDate = new Date(sale.date);
        return saleDate.getMonth() === currentMonth && saleDate.getFullYear() === currentYear;
      }) : [];
      
      let monthlySalesValue = 0;
      let monthlyProfitValue = 0;
      
      monthlySales.forEach(sale => {
        const product = window._productsCache.find(p => p.id === sale.productId);
        if (product) {
          monthlySalesValue += sale.quantity * sale.pricePerUnit;
          monthlyProfitValue += (sale.pricePerUnit - product.costPrice) * sale.quantity;
        }
      });
      
      document.getElementById('monthly-sales').textContent = formatCurrency(monthlySalesValue);
      document.getElementById('monthly-profit').textContent = formatCurrency(monthlyProfitValue);
      
      // Running average (last 30 days)
      const thirtyDaysAgo = new Date();
      thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
      
      const recentSales = window._salesCache ? window._salesCache.filter(sale => {
        return new Date(sale.date) >= thirtyDaysAgo;
      }) : [];
      
      let recentSalesValue = 0;
      recentSales.forEach(sale => {
        recentSalesValue += sale.quantity * sale.pricePerUnit;
      });
      
      const uniqueDates = new Set(recentSales.map(s => s.date.split('T')[0]));
      const daysWithSales = Math.max(1, uniqueDates.size);
      const dailyAverage = recentSalesValue / daysWithSales;
      document.getElementById('running-average').textContent = formatCurrency(dailyAverage);

    }

    // ========== LOW STOCK ALERTS ==========
    async function loadLowStockAlerts() {
      showTabLoading('dashboard');
      try {
        const products = window._productsCache || [];
        const lowStockProducts = products.filter(product => product.quantity <= 5); // Threshold of 10 units
        
        const tbody = document.getElementById('low-stock-alerts');
        if (!tbody) {
          console.error("Element with ID 'low-stock-alerts' not found");
          return;
        }
        
        tbody.innerHTML = '';
        
        if (lowStockProducts.length === 0) {
          tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;">No low stock items</td></tr>';
          return;
        }
        
        lowStockProducts.forEach(product => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${product.name.toUpperCase()}</td> <!-- Product name in uppercase -->
            <td>${product.quantity}</td>
            <td>
              <button class="btn btn-primary edit-product" data-id="${product.id}">Restock</button>
            </td>
          `;
          tbody.appendChild(tr);
        });
        
        // Add event listeners to restock buttons
        document.querySelectorAll('.edit-product').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const id = Number(e.currentTarget.dataset.id);
            openEditProductModal(id);
          });
        });
      } finally {
        hideTabLoading('dashboard');
      }
    }

    // ========== STOCK VALUE ==========
    function updateStockValue(products) {
      let totalValue = 0;
      products.forEach(product => {
        totalValue += product.quantity * product.costPrice;
      });
      document.getElementById('total-stock-value').textContent = formatCurrency(totalValue);
    }

    // ========== BILL GENERATION ==========
    function generateBillContent(items, customerInfo) {
      const today = new Date();
      const billNumber = 'RAJ-' + today.getFullYear() + '-' + 
                        (today.getMonth() + 1).toString().padStart(2, '0') + '-' + 
                        Math.floor(1000 + Math.random() * 9000);
      
      let totalAmount = 0;
      items.forEach(item => {
        totalAmount += item.total;
      });
      
      let itemsHTML = '';
      items.forEach(item => {
        itemsHTML += `
          <tr>
            <td style="padding: 10px; border-bottom: 1px solid #eee;">${item.productName}</td>
            <td style="padding: 10px; text-align: right; border-bottom: 1px solid #eee;">${item.quantity}</td>
            <td style="padding: 10px; text-align: right; border-bottom: 1px solid #eee;">${formatCurrency(item.pricePerUnit)}</td>
            <td style="padding: 10px; text-align: right; border-bottom: 1px solid #eee;">${formatCurrency(item.total)}</td>
          </tr>
        `;
      });
      
      let billHTML = `
        <div style="text-align: center; margin-bottom: 20px; border-bottom: 2px solid #ddd; padding-bottom: 15px;">
          <h2 style="margin-bottom: 5px; color: var(--primary);">Raj Enterprise</h2>
          <p style="margin: 0; color: #666;">Stock & Sales Management</p>
          <h6 style="margin: 0; color: #666;">PH - 6386620244</h6>
        </div>
        
        <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
          <div>
            <p style="margin: 5px 0;"><strong>Bill No:</strong> ${billNumber}</p>
            <p style="margin: 5px 0;"><strong>Date:</strong> ${today.toLocaleDateString()}</p>
            <p style="margin: 5px 0;"><strong>Time:</strong> ${today.toLocaleTimeString()}</p>
          </div>
          <div>
            <p style="margin: 5px 0;"><strong>Customer:</strong> ${customerInfo.name || 'Walk-in Customer'}</p>
            ${customerInfo.phone ? `<p style="margin: 5px 0;"><strong>Phone:</strong> ${customerInfo.phone}</p>` : ''}
          </div>
        </div>
        
        <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
          <thead>
            <tr style="background: #f5f5f5;">
              <th style="padding: 10px; text-align: left; border-bottom: 1px solid #ddd;">Product</th>
              <th style="padding: 10px; text-align: right; border-bottom: 1px solid #ddd;">Quantity</th>
              <th style="padding: 10px; text-align: right; border-bottom: 1px solid #ddd;">Price</th>
              <th style="padding: 10px; text-align: right; border-bottom: 1px solid #ddd;">Total</th>
            </tr>
          </thead>
          <tbody>
            ${itemsHTML}
          </tbody>
          <tfoot>
            <tr>
              <td colspan="3" style="padding: 10px; text-align: right; border-top: 2px solid #ddd;"><strong>Grand Total:</strong></td>
              <td style="padding: 10px; text-align: right; border-top: 2px solid #ddd;"><strong>${formatCurrency(totalAmount)}</strong></td>
            </tr>
          </tfoot>
        </table>
        
        ${customerInfo.address ? `
        <div style="margin-bottom: 20px;">
          <p style="margin: 5px 0;"><strong>Delivery Address:</strong></p>
          <p style="margin: 5px 0; padding: 8px; background: #f9f9f9; border-radius: 4px;">${customerInfo.address}</p>
        </div>
        ` : ''}
        
        <div style="margin-top: 30px; text-align: center; color: #777;">
          <p>Thank you for your business!</p>
          <p>Raj Enterprise - Quality Products, Best Prices</p>
        </div>
      `;
      
      return billHTML;
    }

    function printBill() {
      const billContent = document.getElementById('bill-content').innerHTML;
      const originalContent = document.body.innerHTML;
      
      document.body.innerHTML = billContent;
      window.print();
      document.body.innerHTML = originalContent;
      
      // Reload the page to restore functionality
      location.reload();
    }

    // ========== EVENT LISTENERS ==========
    // Add search functionality for stock
    document.getElementById('stock-search').addEventListener('input', function(e) {
      const searchTerm = e.target.value.toLowerCase();
      const rows = document.querySelectorAll('#stock-table tr');
      
      rows.forEach(row => {
        // Skip the header row and any "no products" message rows
        if (row.cells.length < 2 || row.cells[0].colSpan > 1) return;
        
        const productName = row.cells[1].textContent.toLowerCase(); // Second column has product name
        row.style.display = productName.includes(searchTerm) ? '' : 'none';
      });
    });

    // === Offline Queue Helpers ===
    function loadOfflineQueue() {
      try { return JSON.parse(localStorage.getItem('offlineQueue') || '[]'); } 
      catch { return []; }
    }

    function saveOfflineQueue() {
      localStorage.setItem('offlineQueue', JSON.stringify(window.offlineQueue || []));
    }

    function enqueueOffline(action) {
      window.offlineQueue = window.offlineQueue || [];
      window.offlineQueue.push(action);
      saveOfflineQueue();
      updateSyncButton();
    }


    document.addEventListener('DOMContentLoaded', async function() {
      // Initialize database
      try {
        await openDB();
        await loadInitialData();
        
        // Setup autocomplete
        setupProductSearchAutocomplete();
        
        // Update current date
        document.getElementById('header-date').textContent = new Date().toLocaleDateString('en-GB', {
          day: '2-digit', month: 'short', year: 'numeric'
        }) + ' â–¼';
        
        // Setup tab switching
        document.querySelectorAll('.tab').forEach(tab => {
          tab.addEventListener('click', function() {
            const target = this.dataset.target;
            
            // Update active tab
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            window.offlineQueue = loadOfflineQueue();
            updateSyncButton();
            
            // Update active content section
            document.querySelectorAll('.content-section').forEach(section => {
              section.classList.remove('active');
            });
            document.getElementById(target).classList.add('active');
            window.offlineQueue = loadOfflineQueue();
            updateSyncButton();
            
            // Load data for the selected tab if needed
            if (target === 'reports') {
              // Set default date range for reports (current month)
              const today = new Date();
              const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
              const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
              
              document.getElementById('report-from').value = firstDay.toISOString().split('T')[0];
              document.getElementById('report-to').value = lastDay.toISOString().split('T')[0];
            }
          });
        });
        
        // Add to Bill button
        document.getElementById('add-to-bill').addEventListener('click', addItemToBill);
        
        // Generate Bill button
        document.getElementById('generate-bill-btn').addEventListener('click', function() {
          if (currentBillItems.length === 0) {
            showNotification('No items in bill', 'error');
            return;
          }
          
          // Get customer info
          const customerInfo = {
            name: document.getElementById('customer-name').value,
            phone: document.getElementById('customer-phone').value,
            address: document.getElementById('customer-address').value
          };
          
          generateBillFromItems(currentBillItems, customerInfo);
        });
        
        // Sale form submission
        document.getElementById('sale-form').addEventListener('submit', async function(e) {
          e.preventDefault();
          await recordBillSale();
        });
        
        // Generate bill from existing sale
        document.getElementById('generate-bill-from-sale').addEventListener('click', function() {
          openSelectSalesModal();
        });
        
        // Generate bill from selected sales
        document.getElementById('generate-bill-from-selected').addEventListener('click', function() {
          const selectedSales = [];
          document.querySelectorAll('.select-sale-checkbox:checked').forEach(checkbox => {
            selectedSales.push(parseInt(checkbox.dataset.id));
          });
          
          if (selectedSales.length === 0) {
            showNotification('Please select at least one sale', 'error');
            return;
          }
          
          generateBillForSelectedSales(selectedSales);
          document.getElementById('select-sales-modal').style.display = 'none';
        });
        
        // Product form submission
        document.getElementById('product-form').addEventListener('submit', async function(e) {
          e.preventDefault();
          
          // Validate form
          if (!validateRequiredInput(document.getElementById('product-name'), document.getElementById('name-error')) ||
              !validateNumberInput(document.getElementById('product-quantity'), document.getElementById('init-qty-error'), 0) ||
              !validateNumberInput(document.getElementById('product-cost'), document.getElementById('cost-error'), 0) ||
              !validateNumberInput(document.getElementById('product-mrp'), document.getElementById('mrp-error'), 0) ||
              !validateNumberInput(document.getElementById('product-tax'), document.getElementById('tax-error'), 0)) {
            return;
          }
          
          // Add product
          await addProduct({
            name: document.getElementById('product-name').value,
            quantity: Number(document.getElementById('product-quantity').value),
            costPrice: Number(document.getElementById('product-cost').value),
            mrp: Number(document.getElementById('product-mrp').value),
            tax: Number(document.getElementById('product-tax').value)
          });
        });
        
        // Edit product form submission
        document.getElementById('edit-product-form').addEventListener('submit', async function(e) {
          e.preventDefault();
          
          // Validate form
          if (!validateRequiredInput(document.getElementById('edit-product-name'), document.getElementById('edit-name-error')) ||
              !validateNumberInput(document.getElementById('edit-product-quantity'), document.getElementById('edit-qty-error'), 0) ||
              !validateNumberInput(document.getElementById('edit-product-cost'), document.getElementById('edit-cost-error'), 0) ||
              !validateNumberInput(document.getElementById('edit-product-mrp'), document.getElementById('edit-mrp-error'), 0) ||
              !validateNumberInput(document.getElementById('edit-product-tax'), document.getElementById('edit-tax-error'), 0)) {
            return;
          }
          
          // Update product
          await updateProduct({
            id: Number(document.getElementById('edit-product-id').value),
            name: document.getElementById('edit-product-name').value,
            quantity: Number(document.getElementById('edit-product-quantity').value),
            costPrice: Number(document.getElementById('edit-product-cost').value),
            mrp: Number(document.getElementById('edit-product-mrp').value),
            tax: Number(document.getElementById('edit-product-tax').value)
          });
        });
        
        // Edit sale form submission
        document.getElementById('edit-sale-form').addEventListener('submit', async function(e) {
          e.preventDefault();
          
          // Validate form
          if (!validateNumberInput(document.getElementById('edit-sale-quantity'), document.getElementById('edit-sale-qty-error'), 0.01) ||
              !validateNumberInput(document.getElementById('edit-sale-price'), document.getElementById('edit-sale-price-error'), 0.01)) {
            return;
          }
          
          // Update sale
          await updateSale({
            id: Number(document.getElementById('edit-sale-id').value),
            productId: window._salesCache.find(s => s.id === Number(document.getElementById('edit-sale-id').value)).productId,
            quantity: Number(document.getElementById('edit-sale-quantity').value),
            pricePerUnit: Number(document.getElementById('edit-sale-price').value),
            date: window._salesCache.find(s => s.id === Number(document.getElementById('edit-sale-id').value)).date
          });
        });
        
        // Close modals
        document.getElementById('close-edit-product').addEventListener('click', function() {
          document.getElementById('edit-product-modal').style.display = 'none';
        });
        
        document.getElementById('close-edit-sale').addEventListener('click', function() {
          document.getElementById('edit-sale-modal').style.display = 'none';
        });

        // Close bill modal
        document.getElementById('close-bill').addEventListener('click', function() {
          document.getElementById('bill-modal').style.display = 'none';
        });

        // Close select sales modal
        document.getElementById('close-select-sales').addEventListener('click', function() {
          document.getElementById('select-sales-modal').style.display = 'none';
        });

        // Print bill button
        document.getElementById('print-bill-btn').addEventListener('click', printBill);
        
        // Generate report
        document.getElementById('generate-report').addEventListener('click', function() {
          generateReport();
        });
        
        // Check online status
        checkOnlineStatus();
        window.addEventListener('online', checkOnlineStatus);
        window.addEventListener('offline', checkOnlineStatus);
        
      } catch (err) {
        console.error('Failed to initialize app:', err);
        showNotification('Failed to initialize application', 'error');
      }
    });

    // ========== ONLINE STATUS ==========
    function checkOnlineStatus() {
      const connectionEl = document.getElementById('connection');
      const connText = document.getElementById('conn-text');
      const offlineNotice = document.getElementById('offline-notice');
      
      if (navigator.onLine) {
        connectionEl.classList.remove('offline');
        connectionEl.classList.add('online');
        connText.textContent = 'Online';
        offlineNotice.style.display = 'none';
        
        // Try to sync data if we just came back online
        if (window.offlineQueue && window.offlineQueue.length > 0) {
          processOfflineQueue();
        }
      } else {
        connectionEl.classList.remove('online');
        connectionEl.classList.add('offline');
        connText.textContent = 'Offline';
        offlineNotice.style.display = 'block';
        showNotification('Working offline. Changes will sync when online.', 'warning');
      }
      
      updateSyncButton();
    }

    // ========== LOADING INDICATORS ==========
    function showTabLoading(tabName) {
      const loadingEl = document.getElementById(`${tabName}-loading`);
      if (loadingEl) loadingEl.style.display = 'inline-block';
    }
    
    function hideTabLoading(tabName) {
      const loadingEl = document.getElementById(`${tabName}-loading`);
      if (loadingEl) loadingEl.style.display = 'none';
    }

    // ========== REPORTS ==========
    function generateReport() {
      const fromDate = document.getElementById('report-from').value;
      const toDate = document.getElementById('report-to').value;
      
      if (!fromDate || !toDate) {
        showNotification('Please select both from and to dates', 'error');
        return;
      }
      
      const filteredSales = window._salesCache.filter(sale => {
        const saleDate = sale.date.split('T')[0];
        return saleDate >= fromDate && saleDate <= toDate;
      });
      
      let totalSales = 0;
      let totalProfit = 0;
      let itemsSold = 0;
      
      const tbody = document.getElementById('sales-history');
      if (!tbody) {
        console.error("Element with ID 'sales-history' not found");
        return;
      }
      
      tbody.innerHTML = '';
      
      if (filteredSales.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No sales data available for the selected period</td></tr>';
      } else {
        filteredSales.forEach(sale => {
          const product = window._productsCache.find(p => p.id === sale.productId);
          const saleTotal = sale.quantity * sale.pricePerUnit;
          const profit = product ? (sale.pricePerUnit - product.costPrice) * sale.quantity : 0;
          
          totalSales += saleTotal;
          totalProfit += profit;
          itemsSold += sale.quantity;
          
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${new Date(sale.date).toLocaleDateString()}</td>
            <td>${product ? product.name.toUpperCase() : 'Unknown Product'}</td> <!-- Product name in uppercase -->
            <td>${sale.quantity}</td>
            <td>${formatCurrency(saleTotal)}</td>
            <td>${formatCurrency(profit)}</td>
          `;
          tbody.appendChild(tr);
        });
      }
      
      document.getElementById('report-total-sales').textContent = formatCurrency(totalSales);
      document.getElementById('report-total-profit').textContent = formatCurrency(totalProfit);
      document.getElementById('report-items-sold').textContent = itemsSold;
    }

    // ========== BACKUP & RESTORE ==========
    document.getElementById('export-json').addEventListener('click', async function() {
      try {
        // Get all data from IndexedDB
        const products = await promisifyRequest(tx(['products']).objectStore('products').getAll());
        const sales = await promisifyRequest(tx(['sales']).objectStore('sales').getAll());
        const settings = await promisifyRequest(tx(['settings']).objectStore('settings').getAll());
        
        const data = { schemaVersion: 1,
          products,
          sales,
          settings,
          exportedAt: new Date().toISOString()
        };
        
        // Create and download JSON file
        const json = JSON.stringify(data, null, 2);
        const blob = new Blob([json], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = `raj-enterprise-backup-${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showNotification('Backup exported successfully');
      } catch (err) {
        console.error(err);
        showNotification('Error exporting backup', 'error');
      }
    });

    document.getElementById('file-input').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = async function(e) {
        try {
          const data = JSON.parse(e.target.result);
          
          if (!data.products || !data.sales) {
            throw new Error('Invalid backup file format');
          }
          
          // Import data into IndexedDB
          const store = tx(['products', 'sales', 'settings'], 'readwrite');
          
          // Clear existing data
          await promisifyRequest(store.objectStore('products').clear());
          await promisifyRequest(store.objectStore('sales').clear());
          await promisifyRequest(store.objectStore('settings').clear());
          
          // Add imported data
          for (const product of data.products) {
            product.name = product.name || 'Unnamed';
            product.quantity = Number(product.quantity || 0);
            await promisifyRequest(store.objectStore('products').put(product));
          }
          
          for (const sale of data.sales) {
            sale.quantity = Number(sale.quantity || 0);
            sale.pricePerUnit = Number(sale.pricePerUnit || 0);
            await promisifyRequest(store.objectStore('sales').put(sale));
          }
          
          if (data.settings) {
            for (const setting of data.settings) {
              await promisifyRequest(store.objectStore('settings').add(setting));
            }
          }
          
          showNotification('Backup imported successfully');
          
          // Reload all data
          await loadInitialData();
        } catch (err) {
          console.error(err);
          showNotification('Error importing backup', 'error');
        }
      };
      reader.readAsText(file);
    });

    document.getElementById('clear-db').addEventListener('click', async function() {
      if (!confirm('Are you sure you want to clear all data? This action cannot be undone.')) return;
      
      try {
        const store = tx(['products', 'sales', 'settings'], 'readwrite');
        
        await promisifyRequest(store.objectStore('products').clear());
        await promisifyRequest(store.objectStore('sales').clear());
        await promisifyRequest(store.objectStore('settings').clear());
        
        showNotification('All data cleared successfully');
        
        // Reload all data
        await loadInitialData();
      } catch (err) {
        console.error(err);
        showNotification('Error clearing data', 'error');
      }
    });

    // ========== PWA SERVICE WORKER ==========
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        // Only register service worker if served over HTTPS or localhost
        if (window.location.hostname === 'localhost' || window.location.protocol === 'https:') {
          navigator.serviceWorker.register('/sw.js').then(function(registration) {
            console.log('SW registered: ', registration);
          }).catch(function(registrationError) {
            console.log('SW registration failed: ', registrationError);
          });
        }
      });
    }

    // Check if app is running as PWA
    if (window.matchMedia('(display-mode: standalone)').matches) {
      console.log('Running as standalone app!');
      document.body.classList.add('standalone-app');
    }

    // Initialize offline queue
    window.offlineQueue = [];

    // Function to process queued actions when coming back online
    async function processOfflineQueue() {
      if (!window.offlineQueue || window.offlineQueue.length === 0) return;

      const queue = [...window.offlineQueue];
      for (const action of queue) {
        try {
          if (action.type === 'recordBill') {
            await recordBillSaleFromOffline(action); 
            // ðŸ‘‰ you need to write this function to save bill into IndexedDB
          }
          // remove from queue after success
          window.offlineQueue.shift();
          saveOfflineQueue();
        } catch (err) {
          console.error('Failed to sync', err);
          break; // stop on error, retry later
        }
      }
      updateSyncButton();
      showNotification('Syncing offline changes...', 'warning');
      
      for (const action of window.offlineQueue) {
        
        if (!navigator.onLine) {
          enqueueOffline({
            type: 'recordBill',
            items: currentBillItems,      // your array of bill items
            customer: customerInfo,       // your customer details if you have
            createdAt: new Date().toISOString()
          });
          showNotification('Saved offline â€” will sync when online', 'warning');
          return; // stop normal saving
        }
        else {
          try {
            await action();
          } catch (error) {
            console.error('Failed to sync action:', error);
          }
        }
      }
      
      window.offlineQueue = [];
      showNotification('All changes synced successfully!', 'success');
    }

    // Manual sync button
    document.getElementById('manual-sync').addEventListener('click', function() {
      if (navigator.onLine && window.offlineQueue.length > 0) {
        processOfflineQueue();
      }
    });
    window.addEventListener('online', processOfflineQueue);


    // Show/hide sync button based on offline queue
    function updateSyncButton() {
      const syncButton = document.getElementById('manual-sync');
      if (window.offlineQueue && window.offlineQueue.length > 0) {
        syncButton.style.display = 'inline-block';
        syncButton.innerHTML = `<i class="fas fa-sync"></i> Sync ${window.offlineQueue.length} Pending Changes`;
      } else {
        syncButton.style.display = 'none';
      }
    }
  </script>
</body>
</html>